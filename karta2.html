    <!DOCTYPE html>
    <html lang="bg">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>SHADE SEEKERS - –ò–Ω—Ç–µ–ª–∏–≥–µ–Ω—Ç–Ω–∞ –∫–∞—Ä—Ç–∞ –Ω–∞ —Å—è–Ω–∫–∞</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/Leaflet/Leaflet.heat@gh-pages/dist/leaflet-heat.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>
        <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
        <link rel="icon" type="image/png" href="images/logoo2.png">
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            
            body {
                background: linear-gradient(135deg, #1a2a6c, #2c3e50);
                color: #f8f9fa;
                overflow: hidden;
            }
            
            #map {
                height: 100vh;
                z-index: 1;
            }
            
            .glass-panel {
                position: absolute;
                z-index: 1000;
                background: rgba(25, 42, 86, 0.85);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                border: 1px solid rgba(255, 255, 255, 0.1);
                transition: all 0.3s ease;
            }
            
            .controls {
                top: 20px;
                left: 20px;
                width: 320px;
            }
            
            .info-panel {
                top: 20px;
                right: 20px;
                width: 300px;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            h2 {
                color: #4ecca3;
                margin-bottom: 15px;
                font-size: 1.4rem;
                border-bottom: 2px solid #4ecca3;
                padding-bottom: 8px;
            }
            
            .controls button {
                display: flex;
                align-items: center;
                width: 100%;
                margin: 10px 0;
                padding: 12px 15px;
                background: linear-gradient(135deg, #4ecca3, #3aa98f);
                border: none;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }
            
            .controls button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            }
            
            .controls button i {
                margin-right: 10px;
                font-size: 1.2rem;
            }
            
            .heatmap-btn {
                background: linear-gradient(135deg, #ff6b6b, #ff5252) !important;
            }
            
            #sosBtn {
                background: linear-gradient(135deg, #ff6b6b, #ff5252);
                margin-top: 20px;
                border-top: 2px solid rgba(255, 255, 255, 0.2);
                padding-top: 15px;
            }
            
            .sos-section {
                margin-top: 20px;
                padding-top: 20px;
                border-top: 2px solid rgba(255, 255, 255, 0.2);
            }
            
            .sos-label {
                color: #ff6b6b;
                font-weight: bold;
                margin-bottom: 10px;
                text-align: center;
            }
            
            .time-selector {
                display: flex;
                justify-content: space-between;
                margin: 15px 0;
            }
            
            .time-btn {
                background: rgba(78, 204, 163, 0.2);
                border: 1px solid #4ecca3;
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-size: 0.85rem;
            }
            
            .time-btn.active {
                background: #4ecca3;
                color: #1a2a6c;
                font-weight: bold;
            }
            
            .progress-container {
                margin: 15px 0;
            }
            
            .progress-bar {
                height: 12px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                margin-top: 8px;
                overflow: hidden;
            }
            
            .progress {
                height: 100%;
                background: linear-gradient(90deg, #4ecca3, #3a86ff);
                border-radius: 10px;
                transition: width 0.5s ease;
            }
            
            .info-item {
                display: flex;
                justify-content: space-between;
                margin: 10px 0;
                padding: 10px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .legend {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 15px;
            }
            
            .legend-item {
                display: flex;
                align-items: center;
                font-size: 0.9rem;
            }
            
            .legend-color {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                margin-right: 8px;
            }
            
            .sun-widget {
                text-align: center;
                padding: 15px;
                background: rgba(255, 184, 77, 0.15);
                border-radius: 10px;
                margin-top: 15px;
            }
            
            .sun-icon {
                font-size: 2rem;
                color: #ffb84d;
                margin-bottom: 10px;
            }
            
            .snowflake-marker {
                background: linear-gradient(135deg, #3a86ff, #4ecca3);
                border-radius: 50%;
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
                box-shadow: 0 0 15px rgba(58, 134, 255, 0.5);
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
            
            .loading {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                flex-direction: column;
            }
            
            .spinner {
                width: 50px;
                height: 50px;
                border: 5px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: #4ecca3;
                animation: spin 1s ease-in-out infinite;
                margin-bottom: 20px;
            }
            
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            
            .toggle-panel {
                position: absolute;
                top: 50%;
                right: 10px;
                transform: translateY(-50%);
                z-index: 1001;
                background: rgba(25, 42, 86, 0.9);
                border-radius: 10px;
                padding: 10px;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .toggle-panel:hover {
                background: rgba(25, 42, 86, 1);
            }
            
            .leaflet-routing-container {
                display: none;
            }
            
            .heatmap-controls {
                background: rgba(255, 107, 107, 0.1);
                border: 1px solid #ff6b6b;
                border-radius: 10px;
                padding: 15px;
                margin: 15px 0;
            }
            
            .heatmap-controls h3 {
                color: #ff6b6b;
                margin-bottom: 10px;
                font-size: 1.1rem;
            }
            
            .heatmap-controls select {
                width: 100%;
                padding: 8px;
                border-radius: 5px;
                border: none;
                background: rgba(255, 255, 255, 0.9);
                margin: 5px 0;
            }
            /* Add these styles after your global styles */

            .top-search-bar {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: max-content;
    min-width: 380px;
    max-width: 90vw;
    z-index: 3000;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    background: rgba(25, 42, 86, 0.92);
    backdrop-filter: blur(10px);
    padding: 14px 24px 10px 18px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    border-radius: 14px;
    border-bottom: 1.5px solid rgba(78, 204, 163, 0.18);
    gap: 18px;
    }

    .search-container {
    display: flex;
    align-items: center;
    background: rgba(255,255,255,0.10);
    border-radius: 10px;
    padding: 6px 12px;
    box-shadow: 0 2px 8px rgba(78,204,163,0.08);
    }

    #searchBox {
    border: none;
    outline: none;
    background: transparent;
    color: #f8f9fa;
    font-size: 1.1rem;
    padding: 7px 10px;
    width: 220px;
    border-radius: 8px;
    transition: background 0.2s;
    }

    #searchBox::placeholder {
    color: #b2becd;
    opacity: 1;
    }

    .search-btn {
    background: linear-gradient(135deg, #4ecca3, #3a86ff);
    border: none;
    border-radius: 8px;
    color: #fff;
    padding: 7px 14px;
    margin-left: 8px;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    transition: background 0.2s, box-shadow 0.2s;
    box-shadow: 0 2px 8px rgba(78,204,163,0.12);
    }

    .search-btn:hover {
    background: linear-gradient(135deg, #3a86ff, #4ecca3);
    }

    .custom-arrow-left {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    height: 38px;
    background: linear-gradient(135deg, #4ecca3, #3a86ff);
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(78,204,163,0.12);
    cursor: pointer;
    transition: background 0.2s, box-shadow 0.2s;
    }

    .custom-arrow-left i {
    color: #1a2a6c;
    font-size: 1.3rem;
    font-weight: bold;
    }

    .custom-arrow-left:hover {
    background: linear-gradient(135deg, #3a86ff, #4ecca3);
    box-shadow: 0 4px 16px rgba(58,134,255,0.18);
    }

    .close-search-bar {
    background: transparent;
    border: none;
    color: #b2becd;
    font-size: 1.3rem;
    margin-left: 10px;
    cursor: pointer;
    transition: color 0.2s;
    padding: 6px;
    border-radius: 50%;
    }

    .close-search-bar:hover {
    color: #ff6b6b;
    background: rgba(255,255,255,0.08);
    }
    #welcomeOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(10, 20, 30, 0.92);
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    text-align: center;
    padding: 30px;
    backdrop-filter: blur(10px);
    transition: opacity 0.6s ease;
    }

    #welcomeOverlay.hidden {
    opacity: 0;
    pointer-events: none;
    }

    #welcomeOverlay h1 {
    font-size: 2.2rem;
    margin-bottom: 18px;
    color: #4ecca3;
    letter-spacing: 1px;
    }

    #welcomeOverlay p {
    font-size: 1.1rem;
    max-width: 600px;
    margin-bottom: 30px;
    line-height: 1.6;
    color: #e4e6eb;
    }

    #welcomeOverlay button {
    background: linear-gradient(135deg, #4ecca3, #3a86ff);
    border: none;
    border-radius: 10px;
    color: white;
    padding: 14px 32px;
    font-size: 1.2rem;
    cursor: pointer;
    font-weight: bold;
    transition: transform 0.2s ease, box-shadow 0.3s ease;
    box-shadow: 0 6px 20px rgba(58,134,255,0.4);
    }

    #welcomeOverlay button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(78,204,163,0.5);
    }
    /* === –ú–æ–±–∏–ª–Ω–∞ –≤–µ—Ä—Å–∏—è (–¥–æ 768px) === */
@media (max-width: 768px) {

  /* –ö–∞—Ä—Ç–∞—Ç–∞ –≤–∏–Ω–∞–≥–∏ –∑–∞–µ–º–∞ —Ü–µ–ª–∏—è –µ–∫—Ä–∞–Ω */
  #map {
    height: 100vh;
    width: 100vw;
  }

  /* –ü–∞–Ω–µ–ª–∏—Ç–µ —Å—Ç–∞–≤–∞—Ç –ø–ª–∞–≤–∞—â–∏ –∏ —Å–∫—Ä–∏—Ç–∏ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ */
  .glass-panel.controls,
  .glass-panel.info-panel {
    width: 90%;
    left: 5%;
    right: 5%;
    top: auto;
    bottom: 20px;
    max-height: 50vh;
    overflow-y: auto;
    display: none;
    z-index: 3000;
  }

  /* –î–æ–±–∞–≤—è–º–µ –±—É—Ç–æ–Ω–∏ –∑–∞ –±—ä—Ä–∑ –¥–æ—Å—Ç—ä–ø */
  .mobile-toolbar {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    justify-content: space-around;
    background: rgba(25, 42, 86, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 50px;
    padding: 10px 20px;
    width: 90%;
    z-index: 4000;
  }

  .mobile-toolbar button {
    background: none;
    border: none;
    color: #4ecca3;
    font-size: 1.6rem;
    cursor: pointer;
  }

  /* –¢—ä—Ä—Å–∞—á–∫–∞—Ç–∞ —Å—Ç–∞–≤–∞ –∫–æ–º–ø–∞–∫—Ç–Ω–∞ */
  .top-search-bar {
    top: 10px;
    width: 90vw;
    min-width: unset;
    padding: 10px;
  }

  #searchBox {
    width: 140px;
    font-size: 1rem;
  }

  /* Welcome overlay —Å—Ç–∞–≤–∞ –∞–¥–∞–ø—Ç–∏–≤–µ–Ω */
  #welcomeOverlay h1 {
    font-size: 1.6rem;
  }

  #welcomeOverlay p {
    font-size: 1rem;
    padding: 0 10px;
  }

  #welcomeOverlay button {
    font-size: 1rem;
    padding: 10px 24px;
  }
}
        </style>
    </head>
    <!-- –¢—ä—Ä—Å–∞—á–∫–∞ —Å –±—É—Ç–æ–Ω –∑–∞ —Å–∫—Ä–∏–≤–∞–Ω–µ, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–∞–Ω–∞ –Ω–∞–¥ –ø–∞–Ω–µ–ª–∏—Ç–µ, –±–µ–∑ –¥–∞ –≥–∏ –∑–∞–∫—Ä–∏–≤–∞ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <div class="top-search-bar" id="topSearchBar">
    <div class="search-container">
        <input type="text" id="searchBox" placeholder="–¢—ä—Ä—Å–∏ –æ–±–µ–∫—Ç..." />
        <button class="search-btn" onclick="searchObject()">
        <i class="fas fa-search"></i>
        </button>
    </div>
    <div class="custom-arrow-left">
        <i class="fas fa-chevron-left"></i>
    </div>
    <button class="close-search-bar" onclick="document.getElementById('topSearchBar').style.display='none'">
        <i class="fas fa-times"></i>
    </button>
    </div>


    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <div id="welcomeOverlay">
    <h1>–î–æ–±—Ä–µ –¥–æ—à–ª–∏ –≤ Shade Seekers üå≥</h1>
    <p>
        –ò–∑—á–∏—Å–ª—è–≤–∞–π—Ç–µ –Ω–∞–π-—Å–µ–Ω—á–µ—Å—Ç–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç–∏, –æ—Ç–∫—Ä–∏–≤–∞–π—Ç–µ –ø—Ä–æ—Ö–ª–∞–¥–Ω–∏ —Ç–æ—á–∫–∏, –∞–∫—Ç–∏–≤–∏—Ä–∞–π—Ç–µ SOS —Å–∏–≥–Ω–∞–ª
        –∏ –≤–∏–∂–¥–∞–π—Ç–µ —Ç–µ—Ä–º–æ –∫–∞—Ä—Ç–∞ –Ω–∞ –°–æ—Ñ–∏—è. –ù–∏–µ –≤–∏ –ø–æ–º–∞–≥–∞–º–µ –¥–∞ —Å–µ –¥–≤–∏–∂–∏—Ç–µ —É–º–Ω–æ –≤ –∂–µ–≥–∞—Ç–∞
        –∏ –¥–∞ –ø–∞–∑–∏—Ç–µ –ø—Ä–∏—Ä–æ–¥–∞—Ç–∞ –∑–∞–µ–¥–Ω–æ —Å –Ω–∞—Å. 
    </p>
    <button onclick="closeWelcome()">–ó–∞–ø–æ—á–Ω–∏</button>
    </div>


    <div id="map" style="width: 100vw; height: 100vh; position: absolute; top: 0; left: 0;"></div>

    <div class="glass-panel controls" style="position: absolute; top: 20px; left: 20px; z-index: 1000; width: 340px;">
        <h2><i class="fas fa-sliders-h"></i> –ö–æ–Ω—Ç—Ä–æ–ª–∏</h2>
        <div class="time-selector">
            <div class="time-btn active" data-time="current">–°–µ–≥–∞</div>
            <div class="time-btn" data-time="morning">–°—É—Ç—Ä–∏–Ω</div>
            <div class="time-btn" data-time="noon">–û–±–µ–¥</div>
            <div class="time-btn" data-time="evening">–í–µ—á–µ—Ä</div>
        </div>
        <div class="heatmap-controls">
            <h3><i class="fas fa-thermometer-half"></i> –¢–µ—Ä–º–æ –∫–∞—Ä—Ç–∞</h3>
            <select id="heatmapType">
                <option value="temperature">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</option>
                <option value="heat_index">–¢–æ–ø–ª–∏–Ω–µ–Ω –∏–Ω–¥–µ–∫—Å</option>
                <option value="urban_heat">–ì—Ä–∞–¥—Å–∫–∏ –æ—Å—Ç—Ä–æ–≤–∏</option>
                <option value="comfort">–ö–æ–º—Ñ–æ—Ä—Ç –∑–æ–Ω–∏</option>
            </select>
            <button class="heatmap-btn" onclick="toggleAdvancedHeatmap()">
                <i class="fas fa-fire"></i> –ê–∫—Ç–∏–≤–∏—Ä–∞–π —Ç–µ—Ä–º–æ –∫–∞—Ä—Ç–∞
            </button>
        </div>
        <button onclick="filterMarkers('all')">
            <i class="fas fa-map-marker-alt"></i> –ü–æ–∫–∞–∂–∏ –≤—Å–∏—á–∫–∏
        </button>
        <button onclick="filterMarkers('forest')">
            <i class="fas fa-tree"></i> –ó–µ–ª–µ–Ω–∏ –ø–ª–æ—â–∏
        </button>
        <button onclick="filterMarkers('fountain')">
            <i class="fas fa-tint"></i> –ß–µ—à–º–∏—á–∫–∏
        </button>
        <button onclick="filterMarkers('coolspot')">
            <i class="fas fa-snowflake"></i> –°—Ç—É–¥–µ–Ω–∏ –º–µ—Å—Ç–∞
        </button>
        <div class="progress-container">
            <div>–°–∏–ª–∞ –Ω–∞ —Å—è–Ω–∫–∞: <span id="shadePercentage">0%</span></div>
            <div class="progress-bar">
                <div class="progress" id="shadeProgress"></div>
            </div>
        </div>
        <div class="sos-section">
            <div class="sos-label">–°–ü–ï–®–ù–û–°–¢</div>
            <button id="sosBtn" onclick="sendSOS()">
                <i class="fas fa-exclamation-triangle"></i> SOS –°–∏–≥–Ω–∞–ª
            </button>
        </div>
        <!-- <div style="margin-top: 18px;">
            <input type="text" id="searchBox" placeholder="–¢—ä—Ä—Å–∏ –æ–±–µ–∫—Ç..." style="width: 90%; padding: 7px; border-radius: 5px; border: 1px solid #ccc;">
            <button onclick="searchObject()" style="padding: 7px 12px; border-radius: 5px; background: #4ecca3; color: white; border: none; margin-left: 5px;"><i class="fas fa-search"></i></button>
        </div> -->
    </div>

    <div class="glass-panel info-panel" id="infoPanel" style="position: absolute; top: 20px; right: 20px; z-index: 1000; width: 340px;">
        <h2><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <div class="info-item">
            <span>–°—Ç–∞—Ç—É—Å:</span>
            <span id="status">–ì–æ—Ç–æ–≤ –∑–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è</span>
        </div>
        <div class="info-item">
            <span>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span>
            <span id="temperature">Loading...</span>
        </div>
        <div class="info-item">
            <span>UV –∏–Ω–¥–µ–∫—Å:</span>
            <span id="uvIndex">Loading...</span>
        </div>
        <div class="info-item">
            <span>–¢–µ—Ä–º–æ –∫–∞—Ä—Ç–∞:</span>
            <span id="heatmapStatus">–ù–µ–∞–∫—Ç–∏–≤–Ω–∞</span>
        </div>
        <div class="sun-widget">
            <div class="sun-icon"><i class="fas fa-sun"></i></div>
            <div id="sunPosition">–°–ª—ä–Ω—Ü–µ: Loading...</div>
        </div>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #0066ff;"></div>
                <span>–°—Ç—É–¥–µ–Ω–æ (15-20¬∞C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4ecca3;"></div>
                <span>–ö–æ–º—Ñ–æ—Ä—Ç (20-25¬∞C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffb84d;"></div>
                <span>–¢–æ–ø–ª–æ (25-30¬∞C)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6b6b;"></div>
                <span>–ì–æ—Ä–µ—â–æ (30¬∞C+)</span>
            </div>
        </div>
    </div>

    <div class="toggle-panel" onclick="toggleInfoPanel()" style="position: absolute; top: 50%; right: 0; z-index: 1001; background: #fff; border-radius: 8px 0 0 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 8px 12px; cursor: pointer;">
        <i class="fas fa-chevron-right" id="toggleIcon"></i>
    </div>

    <div class="loading" id="loading" style="display: none; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255,255,255,0.7); z-index: 2000; align-items: center; justify-content: center; flex-direction: column;">
        <div class="spinner"></div>
        <div id="loadingText">–ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ —Ç–µ—Ä–º–æ –∫–∞—Ä—Ç–∞...</div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/suncalc/suncalc.js"></script>

    <script>
    const SOFIA_TEMPERATURE_DATA = {
        current: null,
        yesterday: {
            morning: { baseTemp: 17, uvIndex: 2, humidity: 78, windSpeed: 1.5 },
            noon: { baseTemp: 28, uvIndex: 6, humidity: 45, windSpeed: 3.2 },
            evening: { baseTemp: 25, uvIndex: 3, humidity: 58, windSpeed: 2.8 }
        }
    };

    const SOFIA_GEO_DATA = {
        urbanHeatIslands: [
            { lat: 42.6977, lon: 23.3219, intensity: 3.5, radius: 2000 },
            { lat: 42.6908, lon: 23.3188, intensity: 2.8, radius: 1500 },
            { lat: 42.7014, lon: 23.3367, intensity: 2.2, radius: 1200 },
            { lat: 42.6722, lon: 23.3143, intensity: 2.5, radius: 1000 },
        ],
        elevationPoints: [
            { lat: 42.6525, lon: 23.2833, elevation: 650 },
            { lat: 42.6977, lon: 23.3219, elevation: 550 },
            { lat: 42.7200, lon: 23.3500, elevation: 580 },
            { lat: 42.6500, lon: 23.3800, elevation: 590 },
        ],
        industrialZones: [
            { lat: 42.7100, lon: 23.2800, intensity: 4.0, radius: 800 },
            { lat: 42.6600, lon: 23.3600, intensity: 3.2, radius: 600 },
        ],
        majorRoads: [
            { path: [[42.6850, 23.3050], [42.6950, 23.3150]], intensity: 1.8 },
            { path: [[42.6900, 23.3100], [42.7000, 23.3200]], intensity: 1.5 },
        ]
    };

    const SOFIA_TREE_DATABASE = {
        "–ë–æ—Ä–∏—Å–æ–≤–∞ –≥—Ä–∞–¥–∏–Ω–∞": {
            totalTrees: 2847,
            species: ["–õ–∏–ø–∞", "–î—ä–±", "–ö–µ—Å—Ç–µ–Ω", "–ê–∫–∞—Ü–∏—è"],
            coverage: 85,
            avgHeight: 15,
            shadeRadius: 12,
            coolingEffect: -4.2
        },
        "–Æ–∂–µ–Ω –ø–∞—Ä–∫": {
            totalTrees: 1652,
            species: ["–°–º—ä—Ä—á", "–ë–æ—Ä", "–ö–ª–µ–Ω"],
            coverage: 72,
            avgHeight: 18,
            shadeRadius: 10,
            coolingEffect: -3.8
        },
        "–ß–µ—à–º–∞ –ó–∞–ø–∞–¥–µ–Ω –ø–∞—Ä–∫": {
            totalTrees: 234,
            species: ["–í—ä—Ä–±–∞", "–¢–æ–ø–æ–ª–∞"],
            coverage: 45,
            avgHeight: 12,
            shadeRadius: 8,
            coolingEffect: -2.1
        },
        "–ß–µ—à–º–∞ –û—Ä–ª–æ–≤ –º–æ—Å—Ç": {
            totalTrees: 89,
            species: ["–ö–ª–µ–Ω", "–õ–∏–ø–∞"],
            coverage: 35,
            avgHeight: 10,
            shadeRadius: 6,
            coolingEffect: -1.5
        },
        "–ß–µ—à–º–∞ –ù–î–ö": {
            totalTrees: 156,
            species: ["–ü–ª–∞—Ç–∞–Ω", "–ö–∞—à—Ç–∞–Ω"],
            coverage: 42,
            avgHeight: 14,
            shadeRadius: 9,
            coolingEffect: -1.8
        },
        "–õ–∞–≤–∫–∞ —Å—è–Ω–∫–∞": {
            totalTrees: 67,
            species: ["–ì–∞–±—ä—Ä", "–õ–∏–ø–∞"],
            coverage: 58,
            avgHeight: 8,
            shadeRadius: 5,
            coolingEffect: -2.2
        },
        "–õ–∞—Ä–≥–æ—Ç–æ ‚Äì —Ö–ª–∞–¥–Ω–æ –º—è—Å—Ç–æ": {
            totalTrees: 45,
            species: ["–ü–ª–∞—Ç–∞–Ω", "–Ø—Å–µ–Ω"],
            coverage: 38,
            avgHeight: 16,
            shadeRadius: 11,
            coolingEffect: -1.9
        },
        "–ì—Ä–∞–¥—Å–∫–∞ –≥—Ä–∞–¥–∏–Ω–∞": {
            totalTrees: 123,
            species: ["–î—ä–±", "–õ–∏–ø–∞", "–ö–ª–µ–Ω"],
            coverage: 52,
            avgHeight: 13,
            shadeRadius: 7,
            coolingEffect: -2.5
        }
    };

    const markersData = [
        { name: "–ë–æ—Ä–∏—Å–æ–≤–∞ –≥—Ä–∞–¥–∏–Ω–∞", lat: 42.681, lon: 23.343, category: "forest", trees: 2847, buildings: 2, coolness: 0.95 },
        { name: "–Æ–∂–µ–Ω –ø–∞—Ä–∫", lat: 42.677, lon: 23.314, category: "forest", trees: 1652, buildings: 1, coolness: 0.9 },
        { name: "–ß–µ—à–º–∞ –ó–∞–ø–∞–¥–µ–Ω –ø–∞—Ä–∫", lat: 42.705, lon: 23.282, category: "fountain", trees: 234, buildings: 2, coolness: 0.78 },
        { name: "–ß–µ—à–º–∞ –û—Ä–ª–æ–≤ –º–æ—Å—Ç", lat: 42.688, lon: 23.335, category: "fountain", trees: 89, buildings: 4, coolness: 0.8 },
        { name: "–ß–µ—à–º–∞ –ù–î–ö", lat: 42.691, lon: 23.318, category: "fountain", trees: 156, buildings: 5, coolness: 0.75 },
        { name: "–õ–∞–≤–∫–∞ —Å—è–Ω–∫–∞", lat: 42.695, lon: 23.315, category: "coolspot", trees: 67, buildings: 3, coolness: 0.7 },
        { name: "–õ–∞—Ä–≥–æ—Ç–æ ‚Äì —Ö–ª–∞–¥–Ω–æ –º—è—Å—Ç–æ", lat: 42.6972, lon: 23.322, category: "coolspot", trees: 45, buildings: 6, coolness: 0.65 },
        { name: "–ì—Ä–∞–¥—Å–∫–∞ –≥—Ä–∞–¥–∏–Ω–∞", lat: 42.695, lon: 23.325, category: "coolspot", trees: 123, buildings: 4, coolness: 0.6 }
    ];

    const buildingsData = [
        { coords: [[42.697, 23.322], [42.697, 23.323], [42.696, 23.323], [42.696, 23.322]], height: 45 },
        { coords: [[42.692, 23.318], [42.692, 23.319], [42.691, 23.319], [42.691, 23.318]], height: 32 },
        { coords: [[42.688, 23.335], [42.688, 23.336], [42.687, 23.336], [42.687, 23.335]], height: 28 },
        { coords: [[42.699, 23.310], [42.699, 23.312], [42.697, 23.312], [42.697, 23.310]], height: 67 },
        { coords: [[42.690, 23.330], [42.690, 23.332], [42.688, 23.332], [42.688, 23.330]], height: 38 }
    ];

    const categories = {
        forest: "–ó–µ–ª–µ–Ω–∏ –ø–ª–æ—â–∏",
        fountain: "–ß–µ—à–º–∏—á–∫–∞",
        coolspot: "–°—Ç—É–¥–µ–Ω–æ –º—è—Å—Ç–æ"
    };

    let markerGroup, heatmapLayer, currentRoute, currentPositionMarker, currentTime, userLocation, selectedTimeOfDay;
    markerGroup = L.layerGroup();
    heatmapLayer = null;
    currentRoute = null;
    currentPositionMarker = null;
    currentTime = new Date();
    userLocation = null;
    selectedTimeOfDay = 'current';

    const map = L.map("map").setView([42.6977, 23.3219], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Map data ¬© OpenStreetMap contributors"
    }).addTo(map);
    markerGroup.addTo(map);

    const routingControl = L.Routing.control({
        waypoints: [],
        routeWhileDragging: false,
        addWaypoints: false,
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: 'walking'
        }),
        createMarker: function() { return null; },
        lineOptions: {
            styles: [{ color: '#6FA1EC', weight: 4, opacity: 0.7 }]
        }
    });

    L.layerGroup().addTo(map);
    L.layerGroup().addTo(map);

    function toggleInfoPanel() {
        const panel = document.getElementById('infoPanel');
        const icon = document.getElementById('toggleIcon');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            icon.className = 'fas fa-chevron-right';
        } else {
            panel.style.display = 'none';
            icon.className = 'fas fa-chevron-left';
        }
    }

    function loadMarkers(filtered = "all") {
        markerGroup.clearLayers();
        markersData.forEach(item => {
            if (filtered === "all" || item.category === filtered) {
                const marker = L.marker([item.lat, item.lon], {
                    icon: L.divIcon({
                        className: 'cool-spot-marker',
                        html: '<div class="snowflake-marker"><i class="fas fa-snowflake"></i></div>',
                        iconSize: [36, 36]
                    })
                }).addTo(markerGroup);
                const treeData = SOFIA_TREE_DATABASE[item.name];
                marker.bindPopup(`
                    <div style="min-width: 280px">
                        <h3 style="color: #3a86ff; margin-bottom: 10px">${item.name}</h3>
                        <p><strong>–¢–∏–ø:</strong> ${categories[item.category]}</p>
                        <hr style="margin: 8px 0; border: 1px solid #eee;">
                        <p><strong>üå≥ –î—ä—Ä–≤–µ—Ç–∞:</strong> ${treeData.totalTrees}</p>
                        <p><strong>üçÉ –í–∏–¥–æ–≤–µ:</strong> ${treeData.species.join(', ')}</p>
                        <p><strong>üåø –ü–æ–∫—Ä–∏—Ç–∏–µ:</strong> ${treeData.coverage}%</p>
                        <p><strong>üìè –°—Ä. –≤–∏—Å–æ—á–∏–Ω–∞:</strong> ${treeData.avgHeight}–º</p>
                        <p><strong>‚òÇÔ∏è –†–∞–¥–∏—É—Å —Å—è–Ω–∫–∞:</strong> ${treeData.shadeRadius}–º</p>
                        <p><strong>‚ùÑÔ∏è –û—Ö–ª–∞–∂–¥–∞–Ω–µ:</strong> ${treeData.coolingEffect}¬∞C</p>
                        <hr style="margin: 8px 0; border: 1px solid #eee;">
                        <p><strong>–ü—Ä–æ—Ö–ª–∞–¥–∞:</strong> ${Math.round(item.coolness * 100)}%</p>
                        <button onclick="navigateTo(${item.lat}, ${item.lon})" 
                            style="margin-top: 12px; padding: 8px 16px; background: #4ecca3; color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%">
                            <i class="fas fa-route"></i> –°–µ–Ω—á–µ—Å—Ç –º–∞—Ä—à—Ä—É—Ç
                        </button>
                    </div>
                `);
            }
        });
    }

    function filterMarkers(cat) {
        loadMarkers(cat);
        document.getElementById('status').textContent = `–ü–æ–∫–∞–∑–≤–∞–º: ${categories[cat] || '–í—Å–∏—á–∫–∏'}`;
    }

    async function fetchCurrentWeather() {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=42.6977&longitude=23.3219&current_weather=true&hourly=temperature_2m,uv_index,relative_humidity_2m,windspeed_10m`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`API error: ${res.status} ${res.statusText}`);
            const data = await res.json();
            const weather = data.current_weather;
            SOFIA_TEMPERATURE_DATA.current = {
                baseTemp: weather.temperature,
                uvIndex: weather.uv_index || 0,
                condition: weather.weathercode || "",
                humidity: data.hourly.relative_humidity_2m ? data.hourly.relative_humidity_2m[weather.time] : 60,
                windSpeed: weather.windspeed
            };
            updateWeatherAndSun();
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
                toggleAdvancedHeatmap();
            }
        } catch (err) {
            SOFIA_TEMPERATURE_DATA.current = { baseTemp: 23, uvIndex: 0, condition: "Clear night", humidity: 65, windSpeed: 2.1 };
            updateWeatherAndSun();
        }
    }

    function calculateTemperatureAtPoint(lat, lon) {
        const weatherData = selectedTimeOfDay === 'current' && SOFIA_TEMPERATURE_DATA.current
            ? SOFIA_TEMPERATURE_DATA.current
            : SOFIA_TEMPERATURE_DATA.yesterday[selectedTimeOfDay];
        let temperature = weatherData.baseTemp;
        SOFIA_GEO_DATA.urbanHeatIslands.forEach(island => {
            const distance = haversineDistance(lat, lon, island.lat, island.lon);
            if (distance < island.radius) {
                const influence = island.intensity * (1 - distance/island.radius);
                temperature += influence;
            }
        });
        const elevation = interpolateElevation(lat, lon);
        const elevationEffect = -(elevation - 550) * 0.006;
        temperature += elevationEffect;
        markersData.forEach(marker => {
            const distance = haversineDistance(lat, lon, marker.lat, marker.lon);
            const treeData = SOFIA_TREE_DATABASE[marker.name];
            if (distance < treeData.shadeRadius * 30) {
                const influence = Math.exp(-distance/200) * Math.abs(treeData.coolingEffect);
                temperature -= influence;
            }
        });
        SOFIA_GEO_DATA.industrialZones.forEach(zone => {
            const distance = haversineDistance(lat, lon, zone.lat, zone.lon);
            if (distance < zone.radius) {
                const influence = zone.intensity * (1 - distance/zone.radius);
                temperature += influence;
            }
        });
        SOFIA_GEO_DATA.majorRoads.forEach(road => {
            const distanceToRoad = distanceToLineSegment([lat, lon], road.path);
            if (distanceToRoad < 100) {
                const influence = road.intensity * (1 - distanceToRoad/100);
                temperature += influence;
            }
        });
        if (selectedTimeOfDay === 'current') {
            const hour = new Date().getHours();
            if (hour >= 22 || hour <= 6) temperature -= 2;
        }
        return Math.round(temperature * 10) / 10;
    }

    function interpolateElevation(lat, lon) {
        let totalWeight = 0;
        let weightedElevation = 0;
        SOFIA_GEO_DATA.elevationPoints.forEach(point => {
            const distance = haversineDistance(lat, lon, point.lat, point.lon);
            const weight = 1 / (distance + 1);
            totalWeight += weight;
            weightedElevation += point.elevation * weight;
        });
        return weightedElevation / totalWeight;
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const œÜ1 = lat1 * Math.PI/180;
        const œÜ2 = lat2 * Math.PI/180;
        const ŒîœÜ = (lat2-lat1) * Math.PI/180;
        const ŒîŒª = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function distanceToLineSegment(point, line) {
        const [p1, p2] = line;
        const distance1 = haversineDistance(point[0], point[1], p1[0], p1[1]);
        const distance2 = haversineDistance(point[0], point[1], p2[0], p2[1]);
        return Math.min(distance1, distance2);
    }

    function updateWeatherAndSun() {
        let weatherData, temp, uvIndex;
        if (selectedTimeOfDay === 'current' && SOFIA_TEMPERATURE_DATA.current) {
            weatherData = SOFIA_TEMPERATURE_DATA.current;
            temp = weatherData.baseTemp;
            uvIndex = weatherData.uvIndex;
        } else {
            weatherData = SOFIA_TEMPERATURE_DATA.yesterday[selectedTimeOfDay];
            temp = weatherData.baseTemp;
            uvIndex = weatherData.uvIndex;
        }
        const sunPos = SunCalc.getPosition(currentTime, 42.6977, 23.3219);
        const altitude = Math.round(sunPos.altitude * 180/Math.PI);
        const azimuth = Math.round(sunPos.azimuth * 180/Math.PI);
        document.getElementById('temperature').textContent = `${temp}¬∞C`;
        document.getElementById('uvIndex').textContent = `${uvIndex} (${getUVDescription(uvIndex)})`;
        document.getElementById('sunPosition').textContent = `–°–ª—ä–Ω—Ü–µ: ${altitude}¬∞ –≤–∏—Å–æ—á–∏–Ω–∞, ${azimuth}¬∞ –∞–∑–∏–º—É—Ç`;
    }

    function getUVDescription(uv) {
        if (uv <= 2) return '–Ω–∏—Å—ä–∫';
        if (uv <= 5) return '—É–º–µ—Ä–µ–Ω';
        if (uv <= 7) return '–≤–∏—Å–æ–∫';
        if (uv <= 10) return '–º–Ω–æ–≥–æ –≤–∏—Å–æ–∫';
        return '–µ–∫—Å—Ç—Ä–µ–º–µ–Ω';
    }

    function toggleAdvancedHeatmap() {
        if (heatmapLayer) {
            map.removeLayer(heatmapLayer);
            heatmapLayer = null;
            document.getElementById('heatmapStatus').textContent = '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
            return;
        }
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loadingText').textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ –∫–ª–∏–º–∞—Ç–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏...';
        const heatmapType = document.getElementById('heatmapType').value;
        setTimeout(() => {
            const heatData = [];
            const gridSize = 0.006;
            for (let lat = 42.60; lat < 42.80; lat += gridSize) {
                for (let lon = 23.20; lon < 23.50; lon += gridSize) {
                    let value;
                    switch(heatmapType) {
                        case 'temperature':
                            value = calculateTemperatureAtPoint(lat, lon);
                            break;
                        default:
                            value = calculateTemperatureAtPoint(lat, lon);
                    }
                    const normalized = Math.max(0, Math.min(1, (value - 15) / 20));
                    heatData.push([lat, lon, normalized]);
                }
            }
            heatmapLayer = L.heatLayer(heatData, {
                radius: 35,
                blur: 30,
                maxZoom: 18,
                minOpacity: 0.3,
                gradient: {
                    0.0: '#0066ff',
                    0.2: '#00ccff',
                    0.4: '#4ecca3',
                    0.6: '#ffb84d',
                    0.8: '#ff6b6b',
                    1.0: '#cc0000'
                }
            }).addTo(map);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('heatmapStatus').textContent = `–ê–∫—Ç–∏–≤–Ω–∞: –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞`;
            document.getElementById('status').textContent = '–¢–µ—Ä–º–æ –∫–∞—Ä—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ';
        }, 2000);
    }

    function sendSOS() {
        if (!navigator.geolocation) {
            alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è—Ç–∞ –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞!");
            return;
        }
        document.getElementById('status').textContent = '–ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ SOS —Å–∏–≥–Ω–∞–ª...';
        navigator.geolocation.getCurrentPosition(pos => {
            const { latitude, longitude } = pos.coords;
            if (currentPositionMarker) {
                map.removeLayer(currentPositionMarker);
            }
            currentPositionMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({
                    html: '<div style="background:red;border-radius:50%;width:24px;height:24px;text-align:center;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;animation:pulse 1s infinite;"><i class="fas fa-exclamation"></i></div>',
                    iconSize: [24, 24]
                })
            }).addTo(map)
            .bindPopup("<b>SOS –°–ò–ì–ù–ê–õ –ò–ó–ü–†–ê–¢–ï–ù!</b><br>–í–∞—à–µ—Ç–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ")
            .openPopup();
            document.getElementById("sosBtn").innerHTML = '<i class="fas fa-check-circle"></i> SOS –ò–∑–ø—Ä–∞—Ç–µ–Ω!';
            document.getElementById('status').textContent = 'SOS —Å–∏–≥–Ω–∞–ª –∏–∑–ø—Ä–∞—Ç–µ–Ω —É—Å–ø–µ—à–Ω–æ!';
            map.setView([latitude, longitude], 16);
            userLocation = {lat: latitude, lng: longitude};
        }, () => {
            alert("–ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –ø–æ–ª—É—á–∏ –ª–æ–∫–∞—Ü–∏—è –∑–∞ SOS —Å–∏–≥–Ω–∞–ª.");
            document.getElementById('status').textContent = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ SOS —Å–∏–≥–Ω–∞–ª';
        });
    }

    async function navigateTo(destLat, destLon) {
        if (!navigator.geolocation) {
            alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è—Ç–∞ –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞!");
            return;
        }
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loadingText').textContent = '–û–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ –ª–æ–∫–∞—Ü–∏—è...';
        navigator.geolocation.getCurrentPosition(async pos => {
            const { latitude, longitude } = pos.coords;
            userLocation = {lat: latitude, lng: longitude};
            if (currentPositionMarker && !currentPositionMarker.options.icon.options.html.includes('exclamation')) {
                map.removeLayer(currentPositionMarker);
            }
            const navMarker = L.marker([latitude, longitude], {
                icon: L.divIcon({
                    html: '<div style="background:#4ecca3;border-radius:50%;width:24px;height:24px;text-align:center;display:flex;align-items:center;justify-content:center;color:white;"><i class="fas fa-user"></i></div>',
                    iconSize: [24, 24]
                })
            }).addTo(map)
            .bindPopup("<b>–í–∞—à–µ—Ç–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</b>");
            document.getElementById('loadingText').textContent = '–¢—ä—Ä—Å—è —Å–µ–Ω—á–µ—Å—Ç –º–∞—Ä—à—Ä—É—Ç...';
            if (currentRoute) {
                map.removeControl(routingControl);
                currentRoute = null;
            }
            routingControl.setWaypoints([
                L.latLng(latitude, longitude),
                L.latLng(destLat, destLon)
            ]);
            routingControl.addTo(map);
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const route = routes[0];
                routingControl.getPlan().options.lineOptions.styles = [
                    { color: 'transparent', weight: 0, opacity: 0 }
                ];
                const coords = route.coordinates;
                const shadedPath = [];
                let totalShade = 0;
                for (let i = 0; i < coords.length - 1; i++) {
                    const p1 = [coords[i].lat, coords[i].lng];
                    const p2 = [coords[i+1].lat, coords[i+1].lng];
                    const midPoint = [(p1[0]+p2[0])/2, (p1[1]+p2[1])/2];
                    const shadeFactor = calculateLocationCoolness(midPoint[0], midPoint[1]);
                    totalShade += shadeFactor;
                    let color;
                    if (shadeFactor > 0.7) color = '#3a86ff';
                    else if (shadeFactor > 0.5) color = '#4ecca3';
                    else if (shadeFactor > 0.3) color = '#ffb84d';
                    else color = '#ff6b6b';
                    shadedPath.push(L.polyline([p1, p2], {
                        color: color,
                        weight: 8,
                        opacity: 0.8
                    }));
                }
                currentRoute = L.layerGroup(shadedPath).addTo(map);
                const avgShade = (totalShade / (coords.length - 1)) * 100;
                document.getElementById('shadePercentage').textContent = `${avgShade.toFixed(1)}%`;
                document.getElementById('shadeProgress').style.width = `${avgShade}%`;
                map.fitBounds([
                    [latitude, longitude],
                    [destLat, destLon]
                ], {padding: [20, 20]});
                document.getElementById('loading').style.display = 'none';
                document.getElementById('status').textContent =
                    `–ú–∞—Ä—à—Ä—É—Ç ${route.summary.totalDistance/1000 < 1 ?
                    Math.round(route.summary.totalDistance) + '–º' :
                    (route.summary.totalDistance/1000).toFixed(1) + '–∫–º'} –∑–∞ ${Math.round(route.summary.totalTime/60)}–º–∏–Ω`;
            });
        }, () => {
            alert("–ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –ø–æ–ª—É—á–∏ –ª–æ–∫–∞—Ü–∏—è –∑–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏—è.");
            document.getElementById('loading').style.display = 'none';
            document.getElementById('status').textContent = '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –ª–æ–∫–∞—Ü–∏—è';
        });
    }

    function calculateLocationCoolness(lat, lon) {
        let treeFactor = 0;
        markersData.forEach(marker => {
            const distance = haversineDistance(lat, lon, marker.lat, marker.lon);
            const treeData = SOFIA_TREE_DATABASE[marker.name];
            if (distance < treeData.shadeRadius * 25) {
                const influence = treeData.totalTrees * Math.exp(-distance/150) * (treeData.coverage/100);
                treeFactor += influence * 0.001;
            }
        });
        let buildingFactor = buildingsData.reduce((sum, building) => {
            const buildingCenter = building.coords.reduce((acc, coord) =>
                [acc[0] + coord[0], acc[1] + coord[1]], [0,0])
                .map(val => val / building.coords.length);
            const distance = haversineDistance(lat, lon, buildingCenter[0], buildingCenter[1]);
            if (distance < 200) {
                const sunPos = SunCalc.getPosition(currentTime, lat, lon);
                const shadowDirection = [Math.cos(sunPos.azimuth), Math.sin(sunPos.azimuth)];
                if (isInShadow([lat, lon], building.coords, shadowDirection, building.height)) {
                    return sum + (building.height * 0.02);
                }
            }
            return sum;
        }, 0);
        const sunPos = SunCalc.getPosition(currentTime, lat, lon);
        const altitudeFactor = Math.max(0, 1 - (sunPos.altitude / (Math.PI/2)));
        const coolness = Math.min(0.95,
            (treeFactor * 0.5) +
            (buildingFactor * 0.3) +
            (altitudeFactor * 0.2)
        );
        return coolness;
    }

    function isInShadow(point, buildingCoords, sunDirection, height) {
        const shadowLength = height * 8;
        const shadowCoords = buildingCoords.map(coord => {
            const dx = sunDirection[0] * shadowLength;
            const dy = sunDirection[1] * shadowLength;
            return [coord[0] + dx, coord[1] + dy];
        });
        const shadowPoly = L.polygon([...buildingCoords, ...shadowCoords.reverse()]);
        return shadowPoly.getBounds().contains(point);
    }

    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            selectedTimeOfDay = this.dataset.time;
            const now = new Date();
            switch(selectedTimeOfDay) {
                case 'morning':
                    currentTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0);
                    break;
                case 'noon':
                    currentTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 13, 0);
                    break;
                case 'evening':
                    currentTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 18, 0);
                    break;
                default:
                    currentTime = new Date();
            }
            updateWeatherAndSun();
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
                toggleAdvancedHeatmap();
            }
        });
    });

    function searchObject() {
        const query = document.getElementById('searchBox').value.trim().toLowerCase();
        if (!query) return;
        let found = false;
        markersData.forEach(item => {
            if (item.name.toLowerCase().includes(query)) {
                map.setView([item.lat, item.lon], 16);
                markerGroup.eachLayer(marker => {
                    if (marker.getLatLng().lat === item.lat && marker.getLatLng().lng === item.lon) {
                        marker.openPopup();
                    }
                });
                found = true;
            }
        });
        if (!found) {
            document.getElementById('status').textContent = '–û–±–µ–∫—Ç—ä—Ç –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω!';
        } else {
            document.getElementById('status').textContent = '–û–±–µ–∫—Ç—ä—Ç –µ –Ω–∞–º–µ—Ä–µ–Ω!';
        }
    }

    function initMap() {
        loadMarkers("all");
        fetchCurrentWeather();
        L.polygon([
            [42.60, 23.20], [42.60, 23.50], [42.80, 23.50], [42.80, 23.20]
        ], {color: "#4ecca3", weight: 2, fillOpacity: 0}).addTo(map);
    }

    initMap();
    // === WELCOME OVERLAY ===
    function closeWelcome() {
    document.getElementById('welcomeOverlay').classList.add('hidden');
    localStorage.setItem('welcomeSeen', 'true');
    }

    // window.addEventListener('load', () => {
    //   if (localStorage.getItem('welcomeSeen')) {
    //     document.getElementById('welcomeOverlay').style.display = 'none';
    //   } else {
    //     document.getElementById('welcomeOverlay').style.display = 'flex';
    //   }
    // });
    window.addEventListener('load', () => {
    document.getElementById('welcomeOverlay').style.display = 'flex';
    });
    // === MOBILE PANEL TOGGLE ===
function togglePanel(type) {
  const controls = document.querySelector('.controls');
  const info = document.querySelector('.info-panel');

  if (type === 'controls') {
    controls.style.display = controls.style.display === 'none' || !controls.style.display ? 'block' : 'none';
    info.style.display = 'none';
  } else if (type === 'info') {
    info.style.display = info.style.display === 'none' || !info.style.display ? 'block' : 'none';
    controls.style.display = 'none';
  }
}



    </script>
<!-- === Mobile Toolbar === -->
<div class="mobile-toolbar">
  <button onclick="togglePanel('controls')"><i class="fas fa-sliders-h"></i></button>
  <button onclick="togglePanel('info')"><i class="fas fa-info-circle"></i></button>
  <button onclick="filterMarkers('all')"><i class="fas fa-map"></i></button>
  <button onclick="sendSOS()"><i class="fas fa-exclamation-triangle"></i></button>
</div>

    </html>